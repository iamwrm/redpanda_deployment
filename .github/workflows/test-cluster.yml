name: Test Kafka Cluster

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-kafka-cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Download Apache Kafka
        run: |
          curl -LO https://downloads.apache.org/kafka/3.9.1/kafka_2.13-3.9.1.tgz
          tar -xzf kafka_2.13-3.9.1.tgz
          mv kafka_2.13-3.9.1 kafka

      - name: Generate Cluster ID
        id: cluster-id
        run: |
          CLUSTER_ID=$(kafka/bin/kafka-storage.sh random-uuid)
          echo "cluster_id=$CLUSTER_ID" >> $GITHUB_OUTPUT
          echo "Generated Cluster ID: $CLUSTER_ID"

      - name: Format Kafka Storage
        run: |
          kafka/bin/kafka-storage.sh format -t ${{ steps.cluster-id.outputs.cluster_id }} -c kafka-cluster/broker1/server.properties
          kafka/bin/kafka-storage.sh format -t ${{ steps.cluster-id.outputs.cluster_id }} -c kafka-cluster/broker2/server.properties
          kafka/bin/kafka-storage.sh format -t ${{ steps.cluster-id.outputs.cluster_id }} -c kafka-cluster/broker3/server.properties

      - name: Start Kafka Broker 1
        run: |
          kafka/bin/kafka-server-start.sh kafka-cluster/broker1/server.properties &
          echo $! > broker1.pid
          echo "Broker 1 started with PID $(cat broker1.pid)"

      - name: Start Kafka Broker 2
        run: |
          kafka/bin/kafka-server-start.sh kafka-cluster/broker2/server.properties &
          echo $! > broker2.pid
          echo "Broker 2 started with PID $(cat broker2.pid)"

      - name: Start Kafka Broker 3
        run: |
          kafka/bin/kafka-server-start.sh kafka-cluster/broker3/server.properties &
          echo $! > broker3.pid
          echo "Broker 3 started with PID $(cat broker3.pid)"

      - name: Wait for cluster to form
        run: |
          echo "Waiting for Kafka cluster to form..."
          sleep 20

          # Check if brokers are responsive
          for i in {1..30}; do
            if kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 > /dev/null 2>&1; then
              echo "Cluster is ready!"
              break
            fi
            echo "Waiting for cluster... attempt $i"
            sleep 2
          done

      - name: Verify cluster health
        run: |
          echo "=== Broker API Versions ==="
          kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092,localhost:9192,localhost:9292 | head -10

          echo ""
          echo "=== Create test topic ==="
          kafka/bin/kafka-topics.sh --create --topic ci-test-topic --partitions 3 --replication-factor 3 --bootstrap-server localhost:9092 || true

          echo ""
          echo "=== Describe test topic ==="
          kafka/bin/kafka-topics.sh --describe --topic ci-test-topic --bootstrap-server localhost:9092

      - name: Install Python dependencies
        working-directory: kafka-python-client
        run: uv sync

      - name: Run Python demo
        working-directory: kafka-python-client
        run: |
          echo "=== Running Kafka Python Demo ==="
          uv run python kafka_demo.py

      - name: Verify messages were produced and consumed
        run: |
          echo "=== Verifying topic offsets ==="
          kafka/bin/kafka-get-offsets.sh --bootstrap-server localhost:9092 --topic demo-messages

      - name: Stop Kafka brokers
        if: always()
        run: |
          echo "Stopping Kafka brokers..."
          pkill -f "kafka.Kafka" || true
          echo "Brokers stopped."

  test-redpanda-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Redpanda YAML configs
        run: |
          echo "=== Validating Redpanda configuration files ==="
          for config in redpanda-cluster/node*/redpanda.yaml; do
            echo "Checking $config..."
            python3 -c "import yaml; yaml.safe_load(open('$config'))" && echo "  ✓ Valid YAML"
          done

      - name: Check Kafka properties files
        run: |
          echo "=== Checking Kafka configuration files ==="
          for config in kafka-cluster/broker*/server.properties; do
            echo "Checking $config..."
            if [ -f "$config" ]; then
              # Check required properties exist
              grep -q "node.id=" "$config" && echo "  ✓ node.id present"
              grep -q "process.roles=" "$config" && echo "  ✓ process.roles present"
              grep -q "controller.quorum.voters=" "$config" && echo "  ✓ controller.quorum.voters present"
              grep -q "listeners=" "$config" && echo "  ✓ listeners present"
            fi
          done

      - name: Validate Python project
        working-directory: kafka-python-client
        run: |
          echo "=== Validating Python project ==="
          python3 -c "import ast; ast.parse(open('kafka_demo.py').read())" && echo "✓ kafka_demo.py syntax valid"
          test -f pyproject.toml && echo "✓ pyproject.toml exists"
          test -f uv.lock && echo "✓ uv.lock exists"
