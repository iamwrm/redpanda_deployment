name: Test Redpanda Cluster

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-redpanda-config:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Redpanda YAML configs
        run: |
          echo "=== Validating Redpanda configuration files ==="
          for config in redpanda-cluster/node*/redpanda.yaml; do
            echo "Checking $config..."
            python3 -c "import yaml; yaml.safe_load(open('$config'))" && echo "  âœ“ Valid YAML"
          done

      - name: Verify cluster configuration consistency
        run: |
          echo "=== Verifying cluster configuration ==="
          # Check all nodes have unique node IDs
          for i in 1 2 3; do
            node_id=$(grep -oP 'node_id:\s*\K\d+' redpanda-cluster/node$i/redpanda.yaml)
            echo "Node $i has node_id=$node_id"
          done

          # Check seed servers are configured
          echo ""
          echo "Seed server configuration:"
          grep -A5 "seed_servers:" redpanda-cluster/node1/redpanda.yaml | head -10
